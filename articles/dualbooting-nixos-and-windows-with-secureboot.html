<h1 id="dual-booting-nixos-and-windows-11-with-secureboot">Dual Booting
NixOS and Windows 11 (with SecureBoot)</h1>
<blockquote>
<p>Please do not “follow” this guide. Read the entirety of it and then
make your own informed decisions.</p>
</blockquote>
<blockquote>
<p>I am not sponsored by anyone, I am writing this on my own accord and
the links here were chosen without any bias. I am not liable for any
damages.</p>
</blockquote>
<blockquote>
<p>for any corrections create an issue on the github repo of this
page</p>
</blockquote>
<h2 id="my-current-setup-aka-your-end-result">My Current Setup (AKA your
end result)</h2>
<p>I am currently running Windows 11 and NixOS 23.11 on the same laptop
on the same NVME drive. I am using <code>systemd-boot</code> as my
bootloader to easily switch between my Windows and NixOS installations.
<a href="https://en.wikipedia.org/wiki/UEFI#Secure_Boot">Secure Boot</a>
was enabled using <a
href="https://github.com/nix-community/lanzaboote">lanzaboote</a>.</p>
<h2 id="preface-do-not-skip-this">Preface (Do Not Skip This)</h2>
<p>You will need to wipe your disk so first of all <strong>backup you
data</strong>.</p>
<blockquote>
<p>ALWAYS BACKUP YOUR DATA</p>
</blockquote>
<p>For dual booting, the Windows install instructions is a bit different
so do read through it.</p>
<p>First you will be installing Windows and then NixOS. Since NixOS does
not support secureboot out of the box yet you will have to make it work
by installing <a
href="https://github.com/nix-community/lanzaboote">lanzaboote</a>.</p>
<h3 id="some-general-tips">Some General Tips</h3>
<ul>
<li>The NixOS documentation may or may not be up to date so do not
blindly depend on it.</li>
<li>Having full disk encryption (bitlocker on Windows) is good, but when
dual booting things may go wrong, sometimes after a long time so not
having bitlocker enabled will make recovering your files a lot easier.
Still, use bitlocker if you have to.</li>
</ul>
<h2 id="windows-installation">Windows Installation</h2>
<h3 id="preparing-the-iso">Preparing the ISO</h3>
<p>A regular Windows ISO will do.</p>
<p>To flash the ISO to a USB drive I used <a
href="https://rufus.ie">Rufus</a> form another Windows machine. If you
are using rufus then before flashing the iso to a usb drive rufus will
give you the option to disable bitlocker encryption, you should disable
bitlocker encryption. If you did not get this option then continue as
bitlocker can be disabled after installing Windows.</p>
<p>If you are not using rufus then after installing Windows you will
have to go into the settings and disable bitlocker encryption form
there. (Refer <strong>After Installing Windows</strong> section)</p>
<blockquote>
<p>You can enable bitlocker from Windows after installing both Windows
and NixOS and installing lanzaboote.</p>
</blockquote>
<blockquote>
<p><strong>Disabling bitlocker is important</strong> for the install
process beacuse bitlocker depends on secureboot and we need to disable
secureboot for installing NixOS. If secure boot is disabled and you have
enabled bitlocker you won’t be able to boot into Windows.</p>
</blockquote>
<h3 id="installing-windows">Installing Windows</h3>
<p>During Windows installation select
<code>Custom: Install Windows Only (advanced)</code>. You will be asked
select which drive to install to and to setup the partitions. You will
need to setup a large EFI partition (500MB to 1GB) for dualbooting as
the default EFI partition size on Windows is just 100MB. You can do this
by following this guide.</p>
<p>https://www.ctrl.blog/entry/how-to-esp-Windows-setup.html</p>
<blockquote>
<p>If you are ever planning to dual boot anything with Windows please
consider creating a large EFI partition during Windows install.</p>
</blockquote>
<blockquote>
<p>I have gone with a 1GB EFI partition on my system</p>
</blockquote>
<h3 id="after-installing-windows">After Installing Windows</h3>
<p>If you have not disabled bitlocker from rufus or used another tool to
flash the iso or did not get the disable bitlocker option in rufus the
it is time to do it now. Follow this guide if you are not sure how to do
it.</p>
<p>https://Windowsreport.com/disable-bitlocker-Windows-11/</p>
<p>Now you will have to shrink the current Windows partition to make
space for NixOS. If you are not sure how to do it the follow this
guide.</p>
<blockquote>
<p>The guide shows you different methods to shrink / expand partitions,
but you only need to shrink the partition.</p>
</blockquote>
<blockquote>
<p>You will need to shrink the partition for as much space you need
because resizing partitions after installing both OSs might not be
feasable.</p>
</blockquote>
<p>https://www.howtogeek.com/212/resize-a-partition-on-Windows/</p>
<h2 id="nixos-installation">NixOS Installation</h2>
<h3 id="before-installation">Before Installation</h3>
<ul>
<li>Make sure that <strong>bitlocker is disabled</strong> on
Windows.</li>
<li>Make sure that you have shrank the Windows partition to make space
for NixOS &gt; ⚠️ <strong>DO NOT PROCEED without this</strong></li>
</ul>
<p>Now you will need to <strong>disable secure boot</strong> from the
system’s BIOS. The process for this wiil be different based on your
system’s manufacturer so please look it up and do the necessary.</p>
<p>You will have to flash the NixOS ISO to a usb drive and boot into it.
Again booting from a usb drive will be different based on your system’s
manufacturer so please look it up and do the necessary.</p>
<h3 id="installing-nixos">Installing NixOS</h3>
<p>During installation you will be asked to which partition NixOS should
be installed. Here select replace a partition. On the partition figure
given below that click on the unallocated space that you just made by
shrinking the Windows partition. Continue the installation and you will
have NixOS installed with systemd-boot as the bootloader.</p>
<blockquote>
<p>Be careful when doing this step, do not select the wrong
partition.</p>
</blockquote>
<h3 id="after-installing-nixos">After Installing NixOS</h3>
<p>You have to now go to the bios again and set the default boot option
as <em>Linux Boot Manager</em>. Now when you boot the system you will be
able to select which OS you want to boot into.</p>
<p>But now we have a problem, - Secure boot is not enabled. If it is
enabled again then we cannot boot into NixOS anymore.</p>
<p>To overcome this we have to setup NixOS for secure boot, For this we
are going to use a project called <a
href="https://github.com/nix-community/lanzaboote">lanzaboote</a>.</p>
<h2 id="installing-lanzaboote">Installing Lanzaboote</h2>
<p>Do not follow the instructions for installing lanzaboote from the
NixOS wiki as this might be out of date and definitely <strong>DO NOT
select reset all secureboot keys</strong> anywhere in the bios (you will
get what I mean from the lanzaboote docs).</p>
<p>You will have to follow the lanzaboote docs to install lanzaboote
onto your NixOS system. For this simply follow the lanzaboote docs.</p>
<p>https://github.com/nix-community/lanzaboote/blob/master/docs/QUICK_START.md</p>
<blockquote>
<p>There are two methods given in the lanzaboote docs to install
secureboot, one using nix flakes and another using niv. The niv method
was the one that worked for me.</p>
</blockquote>
<p>If you followed all the instructions properly you should have a
system that can dual boot NixOS and Windows and has secure boot
enabled.</p>
<h2 id="after-all-is-said-and-done">After All is Said and Done</h2>
<p>Refer only the <strong>System Time</strong> section from this NixOS
wiki page, the rest was already done properly during this guide.</p>
<p>https://NixOS.wiki/wiki/Dual_Booting_NixOS_and_Windows</p>
<p>Here are some general tips for using your dual bootable system</p>
<ul>
<li>To clear NixOS generations from the systemd-boot screen you need to
run the <code>nix-collect-garbage</code> command both as a root and
regular user and then rebuild the system.</li>
<li>In systemd-boot during the OS selection screen use the arrow keys to
navigate to the entry you want to make the deafult (like Windows 11) and
press <code>d</code> to make it the default. You can also increase and
decrease the time needed to autoselect the default entry by pressing
<code>t</code> and <code>shift +t</code> respectively.</li>
<li>If you want to switch from Windows to NixOS it is better to select
reboot from the start menu rather that shutdown and then power on again
because during shutdown Windows stores some data on the disk and then
reads it again during startup, this can cause the system to bluescreen
(very rarely) if after the shutdown you boot into another OS (NixOS in
this case) and then boot back into Windows. If you select reboot from
the start menu then the system does a clean restart instead of these
shenanigans.</li>
</ul>
